#!/usr/bin/env bash
# tmux-cc-notify — Claude Code hook handler for tmux status integration
# Called by Claude Code hooks on lifecycle events. Reads JSON from stdin,
# sets @claude_status on the tmux pane for instant status bar updates.
set -euo pipefail

# Exit silently if not in tmux
[[ -z "${TMUX:-}" ]] && exit 0
[[ -z "${TMUX_PANE:-}" ]] && exit 0

EVENT="${1:-}"
[[ -z "$EVENT" ]] && exit 0

# Read JSON from stdin
INPUT=$(cat)

# Map event to status
case "$EVENT" in
    SessionStart)
        # Skip compaction-triggered restarts to avoid overriding WORKING
        source=$(echo "$INPUT" | jq -r '.source // empty' 2>/dev/null)
        [[ "$source" == "compact" ]] && exit 0
        STATUS="IDLE"
        ;;
    UserPromptSubmit)
        STATUS="WORKING"
        ;;
    PreToolUse)
        # Only transition WAITING→WORKING (user granted permission).
        # Skip otherwise to avoid brain-log agent overriding IDLE after Stop.
        current=$(tmux show-option -p -t "$TMUX_PANE" -qv '@claude_status' 2>/dev/null)
        [[ "$current" != "WAITING" ]] && exit 0
        STATUS="WORKING"
        ;;
    Notification)
        STATUS="WAITING"
        ;;
    Stop)
        STATUS="IDLE"
        ;;
    SessionEnd)
        tmux set-option -p -t "$TMUX_PANE" -u '@claude_status' 2>/dev/null || true
        tmux refresh-client -S 2>/dev/null || true
        exit 0
        ;;
    *)
        exit 0
        ;;
esac

# Set status on tmux pane and refresh status bar
tmux set-option -p -t "$TMUX_PANE" '@claude_status' "$STATUS" 2>/dev/null || true
tmux refresh-client -S 2>/dev/null || true
